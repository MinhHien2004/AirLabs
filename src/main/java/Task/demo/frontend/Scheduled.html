<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduled</title>
    <link rel="stylesheet" href="sheduled.css">
</head>

<body>
    <div class="header">
        <input type="text" class="iata" placeholder="Press the airport iata" id="iataInput">
        <button class="refresh-btn">Refresh</button>
    </div>
    <!-- Arrivals Board -->
    <div class="container">
        <div class="board">
            <div class="board-header">
                <div class="status-dots">
                    <span class="dot red"></span>
                    <span class="dot yellow"></span>
                    <span class="dot green"></span>
                </div>
                <span id="arrivalsTitle">Arrivals </span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Carrier</th>
                        <th>Flight</th>
                        <th>Origin</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>

        <div class="board">
            <div class="board-header">
                <div class="status-dots">
                    <span class="dot red"></span>
                    <span class="dot yellow"></span>
                    <span class="dot green"></span>
                </div>
                <span id="departuresTitle">Departures </span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Carrier</th>
                        <th>Flight</th>
                        <th>Destination</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>



    </div>


    <script>
        const iataInput = document.getElementById('iataInput');
        const arrivalsTitle = document.getElementById('arrivalsTitle');
        const departuresTitle = document.getElementById('departuresTitle');
        const refreshBtn = document.querySelector('.refresh-btn');
        
        // Sử dụng relative path để tự động lấy base URL từ current domain
        const getApiUrl = (endpoint) => {
            return `/api/schedules${endpoint}`;
        };

        // Update titles when input changes
        iataInput.addEventListener('input', () => {
            const iata = iataInput.value.trim().toUpperCase();
            arrivalsTitle.textContent = `Arrivals ${iata}`;
            departuresTitle.textContent = `Departures ${iata}`;
        });

        /**
         * Fetch arrivals from backend
         * Backend handles: Cache -> Database -> External API
         */
        async function fetchArrivals(iata) {
            try {
                const response = await fetch(getApiUrl(`/arrivals/${iata}`));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const flights = await response.json();
                console.log('Received arrivals:', flights);
                displayArrivals(flights);
            } catch (error) {
                console.error('Error fetching arrivals:', error);
                displayArrivals([]);
            }
        }

        /**
         * Fetch departures from backend
         * Backend handles: Cache -> Database -> External API
         */
        async function fetchDepartures(iata) {
            try {
                const response = await fetch(getApiUrl(`/departures/${iata}`));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const flights = await response.json();
                console.log('Received departures:', flights);
                displayDepartures(flights);
            } catch (error) {
                console.error('Error fetching departures:', error);
                displayDepartures([]);
            }
        }

        //Display arrivals in table
        function displayArrivals(flights) {
            const tbody = document.querySelector('.container .board:first-child tbody');
            tbody.innerHTML = '';

            if (!flights || flights.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
                return;
            }

            flights.forEach(flight => {
                const row = document.createElement('tr');
                
                // Backend đã tính toán sẵn actual_arr_time và scheduled_arr_time
                const actualTime = flight.actual_arr_time || 'N/A';
                const scheduledTime = flight.scheduled_arr_time;
                let delayedTimeHTML = '';

                // Nếu có delay, hiển thị thời gian cũ
                if (flight.arr_delayed && flight.arr_delayed > 0 && scheduledTime !== actualTime) {
                    delayedTimeHTML = `<span class='old-time'>${scheduledTime}</span>`;
                }

                row.innerHTML = `
                    <td>${actualTime} ${delayedTimeHTML}</td>
                    <td>${flight.airline_iata || "N/A"}</td>
                    <td><a href='#' class="flight-number">${flight.flight_iata || flight.flight_number || 'N/A'}</a></td>
                    <td>${flight.dep_iata || "N/A"}</td>
                    <td class="status ${getStatusClass(flight.status)}">${flight.status || 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Display departures in table
        function displayDepartures(flights) {
            const tbody = document.querySelector('.container .board:last-child tbody');
            tbody.innerHTML = '';

            if (!flights || flights.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
                return;
            }

            flights.forEach(flight => {
                const row = document.createElement('tr');
                
                // Backend đã tính toán sẵn actual_dep_time và scheduled_dep_time
                const actualTime = flight.actual_dep_time || 'N/A';
                const scheduledTime = flight.scheduled_dep_time;
                let delayedTimeHTML = '';

                // Nếu có delay, hiển thị thời gian cũ
                if (flight.dep_delayed && flight.dep_delayed > 0 && scheduledTime !== actualTime) {
                    delayedTimeHTML = `<span class='old-time'>${scheduledTime}</span>`;
                }

                row.innerHTML = `
                    <td>${actualTime} ${delayedTimeHTML}</td>
                    <td>${flight.airline_iata || 'N/A'}</td>
                    <td><a href="#" class="flight-number">${flight.flight_iata || flight.flight_number || 'N/A'}</a></td>
                    <td>${flight.arr_iata || 'N/A'}</td>
                    <td class="status ${getStatusClass(flight.status)}">${flight.status || 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        //Get CSS class based on status
        function getStatusClass(status) {
            if (!status) return "";
            status = status.toLowerCase();
            if (status.includes('landed')) return 'landed';
            if (status.includes('scheduled')) return 'scheduled';
            if (status.includes('delayed')) return 'delayed';
            if (status.includes('en-route') || status.includes('active')) return 'en-route';
            return '';
        }

        //Refesh button click event 
        refreshBtn.addEventListener('click', function () {
            const iata = iataInput.value.toUpperCase().trim();
            if (iata.length == 3) {
                fetchArrivals(iata);
                fetchDepartures(iata);
            } else {
                alert('Please enter a valid Airport IATA');
            }
        });


        //Auto fetch data for default IATA on page load
        let autoRefreshInterval = null;

        function startAutoRefresh() {
            const iata = iataInput.value.toUpperCase().trim();
            if (iata.length === 3) {
                // Clear existing interval if any
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }

                // Set new interval for 30 minutes
                autoRefreshInterval = setInterval(() => {
                    const currentIata = iataInput.value.toUpperCase().trim();
                    if (currentIata.length === 3) {
                        fetchArrivals(currentIata);
                        fetchDepartures(currentIata);
                    }
                }, 30 * 60 * 1000); // 1 minute
            }
        }

        refreshBtn.addEventListener('click', function () {
            const iata = iataInput.value.toUpperCase().trim();
            if (iata.length == 3) {
                fetchArrivals(iata);
                fetchDepartures(iata);
                startAutoRefresh(); // Start auto-refresh
            } else {
                alert('Please enter a valid Airport IATA');
            }
        });
    </script>
</body>

</html>